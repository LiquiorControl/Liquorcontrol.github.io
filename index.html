<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner v42 - Edge Fixed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --font-main: 'Rajdhani', sans-serif; }
        
        body { 
            background-color: #000000;
            background-image: radial-gradient(circle at 50% 0%, #111, #000 80%);
            color: #e2e8f0; 
            font-family: var(--font-main); 
            min-height: 100vh; 
            overscroll-behavior-y: none; 
            -webkit-font-smoothing: antialiased; 
        }

        .edge-card {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 1px #000, 0 8px 30px rgba(0,0,0,0.8);
        }

        .edge-glow-cyan { border-color: rgba(6,182,212,0.4); box-shadow: 0 0 15px rgba(6,182,212,0.15), inset 0 0 20px rgba(6,182,212,0.05); }
        .edge-glow-pink { border-color: rgba(236,72,153,0.4); box-shadow: 0 0 15px rgba(236,72,153,0.15), inset 0 0 20px rgba(236,72,153,0.05); }
        .edge-glow-green { border-color: rgba(34,197,94,0.4); box-shadow: 0 0 15px rgba(34,197,94,0.15), inset 0 0 20px rgba(34,197,94,0.05); }
        .edge-glow-yellow { border-color: rgba(234,179,8,0.4); box-shadow: 0 0 15px rgba(234,179,8,0.15), inset 0 0 20px rgba(234,179,8,0.05); }
        .edge-glow-red { border-color: rgba(239,68,68,0.4); box-shadow: 0 0 15px rgba(239,68,68,0.15), inset 0 0 20px rgba(239,68,68,0.05); }

        .edge-input {
            background: #050505 !important;
            border: 1px solid #333 !important;
            color: #fff !important;
            font-family: monospace;
            transition: 0.3s;
        }
        .edge-input:focus { border-color: #06b6d4 !important; box-shadow: 0 0 15px rgba(6,182,212,0.3) !important; }

        .edge-btn { position: relative; overflow: hidden; transition: all 0.2s; }
        .edge-btn:active { transform: scale(0.96); }
        
        /* ESTILOS PARA EL ESC√ÅNER */
        #reader { 
            border-radius: 1rem; 
            border: 2px solid #06b6d4 !important; 
            box-shadow: 0 0 30px rgba(6,182,212,0.3); 
            background: #000;
        }
        #reader video { object-fit: cover; border-radius: 1rem; }
        #reader__dashboard_section_csr span { display: none !important; } /* Ocultar texto default */
        
        .animate-in { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-backdrop { position: fixed; inset: 0; z-index: 40; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, onSnapshot, setDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyDqdJcKILp5kQ4sTxVm8Ch5E7oXfMD3BAM",
            authDomain: "master-control-palmas.firebaseapp.com",
            projectId: "master-control-palmas",
            storageBucket: "master-control-palmas.firebasestorage.app",
            messagingSenderId: "681752784684",
            appId: "1:681752784684:web:e4a4a4ce96d587380d4689"
        };

        const ZONES_CONFIG = {
            bar1: [ { id: 'bar1_cooler', label: 'Cooler Beer', icon: 'üßä' }, { id: 'bar1_small_cooler_1', label: 'Small 1', icon: '‚ùÑÔ∏è' }, { id: 'bar1_small_cooler_2', label: 'Small 2', icon: '‚ùÑÔ∏è' }, { id: 'bar1_reaching', label: 'Reaching', icon: '‚úã' }, { id: 'bar1_shelf_full', label: 'Shelf Full', icon: 'üçæ' }, { id: 'bar1_shelf_open', label: 'Shelf Open', icon: 'ü•É' }, { id: 'bar1_well_1', label: 'Well 1', icon: 'ü•É' }, { id: 'bar1_well_2', label: 'Well 2', icon: 'ü•É' } ],
            bar2: [ { id: 'bar2_cooler', label: 'Cooler', icon: 'üßä' }, { id: 'bar2_small_cooler', label: 'Small Cooler', icon: '‚ùÑÔ∏è' } ],
            bodega: [ { id: 'bodega_closet', label: 'Closet', icon: 'üö™' }, { id: 'bodega_shelves', label: 'Shelves', icon: 'üóÑÔ∏è' } ]
        };

        // --- SONIDOS ---
        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
                
                const tone = (f, t, d, v=0.1) => {
                    osc.type = t; osc.frequency.setValueAtTime(f, now);
                    gain.gain.setValueAtTime(v, now); gain.gain.exponentialRampToValueAtTime(0.001, now + d);
                    osc.start(now); osc.stop(now + d);
                };

                if (type === 'success') { tone(1000, "sine", 0.1); setTimeout(()=>tone(2000, "sine", 0.3), 100); }
                if (type === 'error') tone(150, "sawtooth", 0.4, 0.2);
                if (type === 'add') tone(800, "sine", 0.15);
                if (type === 'sub') tone(300, "square", 0.15);
                if (type === 'blip') tone(1200, "sine", 0.05, 0.05);
            } catch (e) {}
        };

        // --- ICONOS ---
        const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            Link: (p) => <IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            Scale: (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 9v3"/></IconWrapper>,
            Wrench: (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>,
            Refresh: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21H3v-5"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handlePress = (n) => {
                const newP = pin + n; setPin(newP);
                if (newP === "1130") { playSound('success'); onLogin(); }
                else if (newP.length >= 4) { playSound('error'); setPin(""); }
                else playSound('blip');
            };
            return (
                <div className="fixed inset-0 flex flex-col items-center justify-center p-4 z-50 bg-black">
                    <div className="edge-card w-full max-w-sm p-8 rounded-3xl edge-glow-cyan">
                        <div className="mb-8 text-center">
                            <h1 className="text-4xl font-bold text-white tracking-widest uppercase">Scanner<span className="text-cyan-400">.v42</span></h1>
                            <p className="text-cyan-600/70 text-xs mt-2 font-mono">SECURE ACCESS REQUIRED</p>
                        </div>
                        <div className="flex justify-center gap-4 mb-8">
                            {[0,1,2,3].map(i=><div key={i} className={`w-3 h-3 rounded-full transition-all duration-300 ${pin.length>i?'bg-cyan-400 shadow-[0_0_10px_#22d3ee]':'bg-gray-800 border border-gray-700'}`}></div>)}
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            {[1,2,3,4,5,6,7,8,9,0].map(n=><button key={n} onClick={()=>handlePress(n)} className={`h-20 w-20 rounded-2xl text-2xl font-bold text-white edge-card hover:bg-cyan-900/20 hover:border-cyan-500/50 active:scale-95 transition-all ${n===0?'col-start-2':''}`}>{n}</button>)}
                        </div>
                    </div>
                </div>
            );
        };

        const ModalBase = ({ children, onClose, title, icon:Icon, glowColor="cyan" }) => (
            <div className="fixed inset-0 z-[80] flex flex-col backdrop-blur-xl bg-black/90 animate-in">
                <div className={`p-4 border-b border-white/5 flex justify-between items-center bg-black/50 ${glowColor === 'red' ? 'border-red-900/50' : glowColor === 'green' ? 'border-green-900/50' : glowColor === 'yellow' ? 'border-yellow-900/50' : 'border-cyan-900/50'}`}>
                    <h2 className="text-xl font-bold text-white flex items-center gap-2 font-mono uppercase tracking-wider">
                        {Icon && <Icon className={glowColor==='red'?'text-red-500':glowColor==='green'?'text-green-400':glowColor==='yellow'?'text-yellow-400':'text-cyan-400'} />} 
                        {title}
                    </h2>
                    <button onClick={onClose} className="p-2 px-4 bg-white/5 text-gray-400 rounded-lg hover:text-white hover:bg-white/10 font-bold border border-white/5 uppercase text-xs">Close</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 relative">
                    <div className={`absolute inset-0 pointer-events-none opacity-20 bg-gradient-to-b from-${glowColor}-900/20 to-transparent`}></div>
                    {children}
                </div>
            </div>
        );

        // --- COMPONENTE SCANNER CORREGIDO (FIXED) ---
        const ScannerModal = ({ onScan, onClose }) => {
            useEffect(() => {
                let scanner = null;
                // Esperamos 100ms para asegurar que el div "reader" existe en el DOM
                const timer = setTimeout(() => {
                    try {
                        scanner = new Html5QrcodeScanner(
                            "reader", 
                            { 
                                fps: 10, 
                                qrbox: { width: 250, height: 250 },
                                aspectRatio: 1.0,
                                showTorchButtonIfSupported: true
                            }, 
                            false
                        );
                        scanner.render(
                            (txt) => onScan(txt), 
                            (err) => { /* Ignorar errores de no detecci√≥n frame a frame */ }
                        );
                    } catch (e) {
                        console.error("Camera Init Error:", e);
                        alert("Error de c√°mara. Aseg√∫rate de usar HTTPS o localhost.");
                    }
                }, 100);

                return () => {
                    clearTimeout(timer);
                    if (scanner) { scanner.clear().catch(e=>console.log(e)); }
                };
            }, []);

            return (
                <div className="fixed inset-0 bg-black z-[100] flex flex-col animate-in">
                    <div className="p-6 flex justify-between items-center bg-black/80 backdrop-blur border-b border-cyan-900/50">
                        <h2 className="text-cyan-400 font-mono tracking-widest animate-pulse font-bold">SCANNING...</h2>
                        <button onClick={onClose} className="text-red-500 font-bold uppercase tracking-wider text-xs border border-red-900 p-2 rounded bg-red-900/10">Abort</button>
                    </div>
                    <div className="flex-1 flex items-center justify-center p-4">
                        <div id="reader" className="w-full max-w-sm overflow-hidden rounded-xl border-2 border-cyan-500 shadow-[0_0_50px_rgba(6,182,212,0.3)] bg-black"></div>
                    </div>
                </div>
            );
        };

        const PurchasesLogModal = ({ onClose, data }) => {
            const purchasedItems = []; let totalPurchasedUnits = 0;
            data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item.purchases); if (!isNaN(val) && val > 0) { purchasedItems.push({ ...item, categoryName: cat.category, purchaseVal: val }); totalPurchasedUnits += val; } }); });
            return (
                <ModalBase onClose={onClose} title="Purchases Log" icon={Icons.Package} glowColor="green">
                    {purchasedItems.length === 0 ? <div className="text-center text-gray-500 mt-20 font-mono">NO DATA RECORDED</div> : 
                    <div className="space-y-4 relative z-10">
                        <div className="edge-card p-4 rounded-xl edge-glow-green text-center"><div className="text-xs text-green-400 uppercase font-bold tracking-widest">Total Added Units</div><div className="text-4xl font-black text-white drop-shadow-[0_0_10px_rgba(34,197,94,0.5)]">{totalPurchasedUnits}</div></div>
                        <div className="grid gap-2">{purchasedItems.map((item, idx) => (<div key={idx} className="edge-card p-3 rounded-lg flex justify-between items-center border-l-2 border-green-500"><div><div className="font-bold text-white tracking-wide">{item.name}</div><div className="text-[10px] text-gray-500 uppercase">{item.categoryName}</div></div><div className="text-green-400 font-mono font-bold text-lg">+{item.purchaseVal}</div></div>))}</div>
                    </div>}
                </ModalBase>
            );
        };

        const PremiumControlModal = ({ onClose, data, onUpdateStickers }) => {
            const premiumCategory = data.find(cat => cat.category.includes("Premium"));
            const items = premiumCategory ? premiumCategory.items : [];
            const [searchTerm, setSearchTerm] = useState("");
            const [inputs, setInputs] = useState({});
            const handleInputChange = (itemId, val) => { setInputs(prev => ({ ...prev, [itemId]: val })); };
            const handleAddSticker = (item) => { const newSticker = inputs[item.id]; if (!newSticker || !newSticker.trim()) return; const currentStickers = item.sticker_ids || []; if (currentStickers.includes(newSticker.trim())) { playSound('error'); return; } const newArray = [...currentStickers, newSticker.trim()]; onUpdateStickers(item.id, newArray); setInputs(prev => ({ ...prev, [item.id]: "" })); playSound('add'); };
            const handleRemoveSticker = (item, stickerToRemove) => { const currentStickers = item.sticker_ids || []; const newArray = currentStickers.filter(s => s !== stickerToRemove); onUpdateStickers(item.id, newArray); playSound('sub'); };
            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <ModalBase onClose={onClose} title="Bottle Control" icon={Icons.Star} glowColor="yellow">
                    <div className="mb-4 relative z-10"><Icons.Search className="absolute left-3 top-3 text-gray-500" size={18} /><input type="text" placeholder="Search premium..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full edge-input rounded-xl pl-10 pr-4 py-3 focus:outline-none" /></div>
                    <div className="space-y-4 relative z-10">{filteredItems.map(item => { const stickers = item.sticker_ids || []; return (<div key={item.id} className="edge-card rounded-xl p-4 edge-glow-yellow"><div className="flex justify-between items-start mb-3"><h3 className="font-bold text-white text-lg">{item.name}</h3><div className="bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded text-xs font-mono border border-yellow-500/20">{stickers.length} STOCK</div></div><div className="flex gap-2 mb-4"><input type="number" placeholder="Tag #" className="flex-1 edge-input rounded-lg px-3 py-2 outline-none" value={inputs[item.id] || ""} onChange={(e) => handleInputChange(item.id, e.target.value)} /><button onClick={() => handleAddSticker(item)} className="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-400 border border-yellow-500/50 px-4 py-2 rounded-lg font-bold text-sm transition-all">+ ADD</button></div><div className="flex flex-wrap gap-2">{stickers.length === 0 && <span className="text-xs text-gray-600 font-mono">NO TAGS FOUND</span>}{stickers.map((sticker, idx) => (<button key={idx} onClick={() => handleRemoveSticker(item, sticker)} className="group flex items-center gap-2 bg-black hover:bg-red-900/30 border border-gray-700 hover:border-red-500 px-3 py-1.5 rounded-lg transition-all"><Icons.Barcode size={14} className="text-gray-500 group-hover:text-red-400" /><span className="font-mono font-bold text-gray-300 group-hover:text-red-300">{sticker}</span></button>))}</div></div>); })}</div>
                </ModalBase>
            );
        };

        const LinkModal = ({ barcode, data, onLink, onClose }) => {
            const [search, setSearch] = useState("");
            const filtered = data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(search.toLowerCase())) })).filter(c => c.items.length > 0);
            return (
                <ModalBase onClose={onClose} title="Unknown Code" icon={Icons.Link} glowColor="red">
                    <div className="bg-red-900/10 border border-red-500/30 p-4 rounded-xl text-center font-mono text-red-400 font-bold mb-4 relative z-10">{barcode}</div>
                    <input type="text" placeholder="Search product to link..." className="w-full edge-input rounded-xl py-3 px-4 mb-4 relative z-10" value={search} onChange={e=>setSearch(e.target.value)} autoFocus />
                    <div className="space-y-2 relative z-10">{filtered.map(cat => (<div key={cat.category}><h3 className="text-gray-500 font-mono text-xs uppercase mb-1 ml-2">{cat.category}</h3>{cat.items.map(item => (<button key={item.id} onClick={() => onLink(item)} className="w-full text-left edge-card p-4 rounded-xl mb-2 flex justify-between items-center hover:border-red-400 group transition-all"><span className="font-bold text-white group-hover:text-red-400">{item.name}</span><span className="text-xs text-gray-500">LINK &gt;</span></button>))}</div>))}</div>
                </ModalBase>
            );
        };

        const ReviewModal = ({ onClose, data, onUpdate }) => {
            const mainLocs = [ { id: 'bar1', label: 'Bar 1', color: 'text-cyan-400' }, { id: 'bar2', label: 'Bar 2', color: 'text-pink-400' }, { id: 'bodega', label: 'Storage', color: 'text-yellow-400' }, { id: 'barroluco', label: 'Barroluco', color: 'text-red-400' } ];
            return (
                <ModalBase onClose={onClose} title="Check List" icon={Icons.List} glowColor="cyan">
                    <div className="space-y-8 relative z-10">
                        {mainLocs.map(main => {
                            const subZones = ZONES_CONFIG[main.id] || [];
                            const mainTotal = data.reduce((acc, cat) => acc + cat.items.reduce((iAcc, item) => iAcc + (parseFloat(item[main.id])||0), 0), 0);
                            const directItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[main.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[main.id])}));
                            if (mainTotal === 0) return null;
                            return (
                                <div key={main.id} className="space-y-3">
                                    <div className="sticky top-0 z-20 bg-black/80 backdrop-blur border-b border-white/10 py-2 flex justify-between items-center"><h3 className={`font-black text-xl uppercase tracking-widest ${main.color}`}>{main.label}</h3> <span className="text-white font-mono text-sm bg-white/5 px-2 py-1 rounded border border-white/10">TOTAL: {mainTotal}</span></div>
                                    {subZones.map(zone => { 
                                        const zoneItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[zone.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[zone.id])})); 
                                        if (zoneItems.length === 0) return null; 
                                        return (
                                            <div key={zone.id} className="pl-2 border-l border-white/10 ml-1">
                                                <div className="text-xs font-bold text-gray-500 mb-2 flex items-center gap-2 pl-2 uppercase tracking-wider">{zone.icon} {zone.label}</div>
                                                <div className="grid gap-2">{zoneItems.map(item => (
                                                    <div key={item.id} className="edge-card p-3 rounded-lg flex justify-between items-center">
                                                        <span className="font-medium text-gray-300 text-sm truncate pr-2">{item.name}</span>
                                                        {(zone.id === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo')) && item.breakdown_bar1_cooler) ? (
                                                            <div className="flex flex-col items-end"><span className="text-[10px] text-gray-500 font-mono mb-1">{item.breakdown_bar1_cooler.map(v=>v||0).join('+')}</span><div className="bg-cyan-900/30 border border-cyan-500/30 rounded px-2 py-1 text-right text-cyan-400 font-mono font-bold text-sm">{item.val}</div></div>
                                                        ) : (
                                                            <input type="number" value={item.val} onChange={(e) => { const val = parseFloat(e.target.value) || 0; let newTotal = val; subZones.forEach(z => { if(z.id !== zone.id) newTotal += (parseFloat(item[z.id])||0); }); onUpdate(item.id, { [zone.id]: val, [main.id]: newTotal }); }} className="w-16 edge-input rounded px-2 py-1 text-right font-mono font-bold outline-none"/>
                                                        )}
                                                    </div>))}
                                                </div>
                                            </div>
                                        ); 
                                    })} 
                                    {!subZones.length && directItems.map(item => (<div key={item.id} className="edge-card p-3 rounded-lg flex justify-between items-center"><span className="font-medium text-gray-300 text-sm">{item.name}</span><input type="number" value={item.val} onChange={(e) => onUpdate(item.id, main.id, parseFloat(e.target.value)||0)} className="w-16 edge-input rounded px-2 py-1 text-right font-mono font-bold outline-none"/></div>))}
                                </div>
                            );
                        })}
                        {!data.some(c=>c.items.some(i=>parseFloat(i.bar1)||parseFloat(i.bar2)||parseFloat(i.bodega)||parseFloat(i.barroluco))) && <div className="text-center text-gray-600 mt-20 font-mono uppercase tracking-widest">SYSTEM IDLE // NO DATA</div>}
                    </div>
                </ModalBase>
            );
        };

        const BottleCalibrationModal = ({ item, onClose, onSave }) => {
            const [f, setF] = useState(item.weight_full||""); const [e, setE] = useState(item.weight_empty||"");
            return (
                <div className="fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/90 backdrop-blur animate-in">
                    <div className="edge-card w-full max-w-sm p-6 rounded-2xl edge-glow-pink">
                        <h2 className="text-xl font-bold text-pink-500 mb-4 flex items-center gap-2 uppercase tracking-widest"><Icons.Scale/> Calibrate</h2>
                        <h3 className="text-white mb-6 text-lg font-mono">{item.name}</h3>
                        <div className="space-y-4">
                            <div><label className="text-xs text-gray-500 uppercase font-bold">Full Weight (g)</label><input type="number" value={f} onChange={x=>setF(x.target.value)} className="edge-input w-full p-3 rounded-lg text-xl" autoFocus /></div>
                            <div><label className="text-xs text-gray-500 uppercase font-bold">Empty Weight (g)</label><input type="number" value={e} onChange={x=>setE(x.target.value)} className="edge-input w-full p-3 rounded-lg text-xl" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3 mt-6">
                            <button onClick={onClose} className="py-3 rounded-lg border border-white/10 text-gray-400 hover:text-white uppercase font-bold text-xs">Cancel</button>
                            <button onClick={()=>onSave(item.id,f,e)} className="py-3 rounded-lg bg-pink-600/20 border border-pink-500 text-pink-400 font-bold hover:bg-pink-600/40 transition-all uppercase text-xs">Save Config</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickEditModal = ({ item, onClose, onContinue, onUpdate, initialLocation, initialSubZone, onOpenCalibration }) => {
            const [value, setValue] = useState(0);
            const zones = ZONES_CONFIG[initialLocation] || [];
            const subZoneId = initialSubZone || (zones[0]?.id);
            const targetField = zones.length > 0 ? subZoneId : initialLocation;
            const isOpenZone = ['bar1_shelf_open', 'bar1_well_1', 'bar1_well_2'].includes(initialSubZone);
            const [manualGrams, setManualGrams] = useState("");
            
            // Logic for Multi-count (Corona/Modelo)
            const isMultiCount = (subZoneId === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo')));
            const [slots, setSlots] = useState(() => (isMultiCount && item.breakdown_bar1_cooler) ? item.breakdown_bar1_cooler : [0,0,0,0]);

            useEffect(() => { 
                if(!isMultiCount) setValue(parseFloat(item[targetField]) || 0); 
                else setValue(slots.reduce((a, b) => a + (parseFloat(b)||0), 0));
            }, [item, targetField, slots]);

            const updateValue = (next) => {
                setValue(next);
                if (zones.length > 0) {
                    let newTotal = 0;
                    zones.forEach(z => { if(z.id===subZoneId) newTotal+=next; else newTotal+=(parseFloat(item[z.id])||0); });
                    onUpdate(item.id, { [subZoneId]: next, [initialLocation]: newTotal });
                } else onUpdate(item.id, initialLocation, next);
            };

            const handleSlotChange = (idx, val) => {
                const newSlots = [...slots]; newSlots[idx] = val===""?0:parseFloat(val); setSlots(newSlots);
                const newSum = newSlots.reduce((a,b)=>a+b,0); setValue(newSum);
                let newTotal = 0; zones.forEach(z => { if (z.id === subZoneId) newTotal += newSum; else newTotal += (parseFloat(item[z.id]) || 0); });
                onUpdate(item.id, { [subZoneId]: newSum, [initialLocation]: newTotal, breakdown_bar1_cooler: newSlots });
            };

            const handleDelta = (d) => { const n=Math.max(0, Math.round((value+d)*100)/100); updateValue(n); playSound(d>0?'add':'sub'); };
            
            const calcManual = () => {
                if(!item.weight_full || !item.weight_empty) { onOpenCalibration(item); return; }
                const net = item.weight_full - item.weight_empty;
                const units = Math.max(0, (parseFloat(manualGrams) - item.weight_empty) / net);
                updateValue(Math.round(units*100)/100); playSound('success'); setManualGrams("");
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-2 backdrop-blur-xl bg-black/80">
                    <div className="edge-card w-full max-w-md rounded-3xl overflow-hidden flex flex-col h-[90vh] edge-glow-cyan">
                        <div className="p-4 bg-cyan-900/10 border-b border-cyan-500/20 flex justify-between items-center">
                            <div><h2 className="text-2xl font-bold text-white">{item.name}</h2><div className="text-xs text-cyan-400 font-mono mt-1 uppercase tracking-widest">{subZoneId?.replace(/_/g,' ') || initialLocation}</div></div>
                            <button onClick={onClose} className="bg-red-900/20 text-red-400 p-3 rounded-xl hover:bg-red-900/40 transition-colors">‚úï</button>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-4 relative">
                            {/* Fondo grid sutil */}
                            <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                            
                            <div className="text-[7rem] font-black font-mono tracking-tighter leading-none mb-2 text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] z-10">{value}</div>
                            
                            {isMultiCount ? (
                                <div className="grid grid-cols-2 gap-4 w-full z-10">
                                    <div className="col-span-2 text-center text-xs text-gray-500 uppercase font-bold tracking-widest mb-2">Multi-Slot Count</div>
                                    {slots.map((s,i)=><input key={i} type="number" value={s||""} onChange={(e)=>handleSlotChange(i,e.target.value)} className="edge-input w-full p-4 text-center text-2xl rounded-xl" placeholder={`Slot ${i+1}`} />)}
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 gap-3 w-full max-w-sm z-10">
                                    {!isOpenZone && [24,12,6].map(n=><React.Fragment key={n}>
                                        <button onClick={()=>handleDelta(-n)} className="edge-btn h-12 bg-gray-900 border border-gray-700 rounded-lg text-red-400 font-bold hover:border-red-500 hover:text-red-300">-{n}</button>
                                        <button onClick={()=>handleDelta(n)} className="edge-btn h-12 bg-gray-900 border border-gray-700 rounded-lg text-green-400 font-bold hover:border-green-500 hover:text-green-300">+{n}</button>
                                    </React.Fragment>)}
                                    <button onClick={()=>handleDelta(-1)} className="col-span-1 h-16 edge-btn bg-red-900/20 border border-red-500/50 rounded-xl text-red-400 text-3xl font-bold hover:bg-red-900/40">-1</button>
                                    <button onClick={()=>handleDelta(1)} className="col-span-1 h-16 edge-btn bg-green-900/20 border border-green-500/50 rounded-xl text-green-400 text-3xl font-bold hover:bg-green-900/40">+1</button>
                                    <button onClick={()=>handleDelta(-0.1)} className="h-10 text-gray-500 font-bold border border-white/5 rounded hover:text-white">-.1</button>
                                    <button onClick={()=>handleDelta(0.1)} className="h-10 text-gray-500 font-bold border border-white/5 rounded hover:text-white">+.1</button>
                                </div>
                            )}

                            {isOpenZone && (
                                <div className="mt-6 w-full max-w-sm z-10 border-t border-white/10 pt-4">
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <input type="number" value={manualGrams} onChange={e=>setManualGrams(e.target.value)} placeholder="Weight (g)" className="edge-input w-full p-3 rounded-lg text-lg text-center" />
                                            {!item.weight_full && <button onClick={()=>onOpenCalibration(item)} className="absolute right-2 top-2 text-yellow-500 animate-pulse"><Icons.Wrench size={16}/></button>}
                                        </div>
                                        <button onClick={calcManual} className="edge-btn bg-cyan-600/20 border border-cyan-500 text-cyan-400 px-6 rounded-lg font-bold shadow-[0_0_10px_rgba(6,182,212,0.2)] hover:bg-cyan-600/40">CALC</button>
                                    </div>
                                </div>
                            )}
                        </div>
                        <button onClick={onContinue} className="m-4 h-16 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-2xl text-white font-black text-xl tracking-widest shadow-[0_0_20px_rgba(8,145,178,0.4)] active:scale-95 transition-transform uppercase border border-white/10">Next Scan</button>
                    </div>
                </div>
            );
        };

        const LocationModal = ({ onClose, onSelect }) => {
            const locs = [ {id:'bar1',l:'Bar 1',i:Icons.Beer}, {id:'bar2',l:'Bar 2',i:Icons.Wine}, {id:'bodega',l:'Bodega',i:Icons.Box}, {id:'barroluco',l:'Barroluco',i:Icons.MapPin}, {id:'purchases',l:'Purchases',i:Icons.ShoppingCart} ];
            const [selMain, setSelMain] = useState(null);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 backdrop-blur-xl bg-black/80 animate-in">
                    <div className="edge-card w-full max-w-lg rounded-2xl flex flex-col max-h-[80vh] edge-glow-cyan">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center"><h2 className="text-cyan-400 font-bold uppercase tracking-wider">{selMain ? 'Select Zone' : 'Select Location'}</h2><button onClick={onClose} className="text-gray-500 font-bold hover:text-white uppercase text-xs">Cancel</button></div>
                        <div className="p-4 overflow-y-auto grid grid-cols-2 gap-3">
                            {!selMain ? locs.map(l=><button key={l.id} onClick={()=>{if(ZONES_CONFIG[l.id]) setSelMain(l.id); else onSelect(l.id, null);}} className="edge-card hover:bg-white/5 text-white p-6 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95 border-gray-800 hover:border-cyan-500"><l.i className="w-8 h-8 text-cyan-400"/><span>{l.l}</span></button>) : 
                            ZONES_CONFIG[selMain].map(z=><button key={z.id} onClick={()=>onSelect(selMain, z.id)} className="edge-card hover:bg-white/5 text-white p-6 rounded-xl flex flex-col items-center gap-2 transition-all active:scale-95 border-gray-800 hover:border-cyan-500"><span className="text-2xl">{z.icon}</span><span>{z.label}</span></button>)}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [auth, setAuth] = useState(false);
            const [data, setData] = useState([]);
            const [loc, setLoc] = useState('bar1');
            const [subZone, setSubZone] = useState(null);
            const [scanning, setScanning] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [modals, setModals] = useState({ loc:false, menu:false, check:false, premium:false, purchases:false, calib:null });
            const [search, setSearch] = useState("");
            const [online, setOnline] = useState(navigator.onLine);
            const [uploading, setUploading] = useState(false);
            const [pendingBarcode, setPendingBarcode] = useState(null);

            useEffect(() => {
                const h = () => setOnline(navigator.onLine); window.addEventListener('online', h); window.addEventListener('offline', h);
                const app = window.fb.initializeApp(FIREBASE_CONFIG);
                window.fb.onAuthStateChanged(window.fb.getAuth(app), u => {
                    if(u) {
                        window.fb.onSnapshot(window.fb.doc(window.fb.getFirestore(app), 'inventory', 'master'), s => { if(s.exists()) setData(s.data().items); });
                    } else window.fb.signInAnonymously(window.fb.getAuth(app));
                });
                return () => { window.removeEventListener('online', h); window.removeEventListener('offline', h); }
            }, []);

            const update = (id, field, val) => {
                const newData = data.map(c => ({...c, items: c.items.map(i => i.id===id ? (typeof field==='object'?{...i,...field}:{...i,[field]:val}) : i)}));
                setData(newData);
                window.fb.setDoc(window.fb.doc(window.fb.getFirestore(), 'inventory', 'master'), { items: newData });
            };

            const toggleModal = (k, v) => setModals(p => ({...p, [k]: v}));
            
            const handleScan = (txt) => {
                let found = null; for(const c of data) { const m = c.items.find(i=>(i.barcode?.includes(txt) || i.barcode_case===txt)); if(m){found=m; break;}}
                if(found) { setEditItem(found); setScanning(false); playSound('success'); }
                else { playSound('error'); setPendingBarcode(txt); setScanning(false); }
            };

            const handleLinkBarcode = (item) => {
                const current = item.barcode ? item.barcode : "";
                update(item.id, 'barcode', current ? `${current},${pendingBarcode}` : pendingBarcode);
                setPendingBarcode(null); setEditItem(item); playSound('success');
            };

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob); const link = document.createElement("a");
                link.href = url; link.download = `Scan_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleReset = () => {
                if(!confirm("CLEAR ALL LOCAL COUNTS?")) return;
                const resetData = data.map(c => ({ ...c, items: c.items.map(i => { const r = { ...i }; ['bar1', 'bar2', 'bodega', 'barroluco', 'purchases'].forEach(k => r[k] = 0); Object.values(ZONES_CONFIG).forEach(arr => arr.forEach(z => r[z.id] = 0)); return r; }) }));
                setData(resetData); playSound('sub'); toggleModal('menu',false);
            };

            const filteredData = useMemo(() => {
                const t = search.toLowerCase();
                return data.map(c => ({...c, items: c.items.filter(i => i.name.toLowerCase().includes(t))})).filter(c => c.items.length > 0);
            }, [data, search]);

            if(!auth) return <LoginScreen onLogin={()=>setAuth(true)} />;

            return (
                <div className="pb-32 pt-6 px-4 max-w-xl mx-auto min-h-screen relative">
                    <div className="flex justify-between items-end mb-8 border-b border-white/10 pb-4">
                        <div>
                            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 italic uppercase">Scanner <span className="text-white text-base not-italic">Pro</span></h1>
                            <div className="flex items-center gap-2 mt-1">
                                <span className={`w-2 h-2 rounded-full ${online?'bg-green-500 shadow-[0_0_8px_#22c55e]':'bg-red-500'}`}></span>
                                <span className="text-[10px] font-mono text-gray-500 tracking-widest">{online ? 'SYSTEM ONLINE' : 'OFFLINE MODE'}</span>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={()=>{setUploading(true); setTimeout(()=>setUploading(false),800)}} className={`p-2 rounded-lg border border-indigo-500/30 bg-indigo-900/20 text-indigo-400 ${uploading?'animate-pulse':''}`}><Icons.Upload/></button>
                            <button onClick={()=>toggleModal('menu',!modals.menu)} className="p-2 rounded-lg border border-white/10 bg-white/5 text-gray-300"><Icons.Settings/></button>
                        </div>
                    </div>

                    <button onClick={()=>toggleModal('loc',true)} className="w-full edge-card mb-6 p-4 rounded-xl flex items-center justify-between group hover:border-cyan-500/50 transition-all">
                        <div className="flex items-center gap-4">
                            <div className="bg-cyan-500/10 p-3 rounded-lg text-cyan-400 border border-cyan-500/20"><Icons.MapPin /></div>
                            <div className="text-left">
                                <div className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Target Zone</div>
                                <div className="text-white font-bold text-xl">{subZone ? ZONES_CONFIG[loc].find(z=>z.id===subZone)?.label : loc === 'purchases' ? 'Purchases' : loc.toUpperCase()}</div>
                            </div>
                        </div>
                        <Icons.ChevronDown className="text-gray-600 group-hover:text-cyan-400 transition-colors"/>
                    </button>

                    {modals.menu && (
                        <>
                            <div className="menu-backdrop" onClick={()=>toggleModal('menu',false)}></div>
                            <div className="absolute top-20 right-4 z-50 edge-card p-2 rounded-xl flex flex-col gap-1 w-48 border-gray-700 animate-in">
                                <button onClick={handleReset} className="flex items-center gap-3 p-3 hover:bg-white/5 rounded text-red-400 text-sm font-bold uppercase tracking-wider"><Icons.Refresh size={16}/> Reset Local</button>
                                <button onClick={handleBackup} className="flex items-center gap-3 p-3 hover:bg-white/5 rounded text-green-400 text-sm font-bold uppercase tracking-wider"><Icons.Save size={16}/> Backup JSON</button>
                                <button onClick={()=>toggleModal('purchases',true)} className="flex items-center gap-3 p-3 hover:bg-white/5 rounded text-white text-sm font-bold uppercase tracking-wider"><Icons.Package size={16}/> Purchases</button>
                                <button onClick={()=>toggleModal('check',true)} className="flex items-center gap-3 p-3 hover:bg-white/5 rounded text-white text-sm font-bold uppercase tracking-wider"><Icons.List size={16}/> Checklist</button>
                                <button onClick={()=>toggleModal('premium',true)} className="flex items-center gap-3 p-3 hover:bg-white/5 rounded text-yellow-400 text-sm font-bold uppercase tracking-wider"><Icons.Star size={16}/> Bottle Ctrl</button>
                            </div>
                        </>
                    )}

                    <div className="relative mb-6">
                        <Icons.Search className="absolute left-4 top-3.5 text-gray-600" />
                        <input type="text" placeholder="Search Database..." value={search} onChange={e=>setSearch(e.target.value)} 
                            className="w-full bg-gray-900/50 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-gray-300 focus:border-cyan-500 focus:shadow-[0_0_15px_rgba(6,182,212,0.2)] outline-none transition-all placeholder-gray-700 font-mono" />
                    </div>

                    <div className="space-y-6">
                        {filteredData.map(cat => (
                            <div key={cat.category}>
                                <h3 className="text-cyan-600 font-mono text-[10px] uppercase mb-2 ml-1 tracking-[0.2em] border-l-2 border-cyan-800 pl-2">{cat.category}</h3>
                                <div className="bg-white/5 rounded-2xl overflow-hidden border border-white/5">
                                    {cat.items.map(item => {
                                        const qty = parseFloat(item[subZone || loc]) || 0;
                                        return (
                                            <div key={item.id} onClick={() => setEditItem(item)} className="p-4 border-b border-white/5 last:border-0 flex justify-between items-center hover:bg-white/5 active:bg-cyan-900/20 cursor-pointer transition-colors">
                                                <span className="text-gray-300 font-medium">{item.name}</span>
                                                {qty > 0 && <span className="bg-cyan-500/20 text-cyan-300 px-3 py-1 rounded font-mono font-bold text-sm border border-cyan-500/30 shadow-[0_0_10px_rgba(6,182,212,0.1)]">{qty}</span>}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>

                    <button onClick={() => setScanning(true)} className="fixed bottom-8 left-1/2 -translate-x-1/2 h-20 w-20 bg-black rounded-full shadow-[0_0_30px_#06b6d4] flex items-center justify-center border-2 border-cyan-500 z-30 active:scale-90 transition-all group">
                        <div className="absolute inset-0 rounded-full border border-white/20 animate-ping opacity-20"></div>
                        <Icons.Scan className="text-cyan-400 w-8 h-8 group-hover:scale-110 transition-transform" />
                    </button>

                    {scanning && <ScannerModal onScan={handleScan} onClose={()=>setScanning(false)} />}
                    {editItem && <QuickEditModal item={editItem} initialLocation={loc} initialSubZone={subZone} onClose={()=>setEditItem(null)} onContinue={()=>{setEditItem(null); setTimeout(()=>setScanning(true),300)}} onUpdate={update} onOpenCalibration={i=>toggleModal('calib',i)} />}
                    {modals.loc && <LocationModal onClose={()=>toggleModal('loc',false)} onSelect={(l,s)=>{setLoc(l); setSubZone(s); toggleModal('loc',false)}} />}
                    {modals.calib && <BottleCalibrationModal item={modals.calib} onClose={()=>toggleModal('calib',null)} onSave={(id,f,e)=>{update(id,{weight_full:f,weight_empty:e});toggleModal('calib',null);playSound('success')}} />}
                    {modals.check && <ReviewModal onClose={()=>toggleModal('check',false)} data={data} onUpdate={update} />}
                    {modals.premium && <PremiumControlModal onClose={()=>toggleModal('premium',false)} data={data} onUpdateStickers={(id, arr)=>update(id, 'sticker_ids', arr)} />}
                    {modals.purchases && <PurchasesLogModal onClose={()=>toggleModal('purchases',false)} data={data} />}
                    {pendingBarcode && <LinkModal barcode={pendingBarcode} data={data} onLink={handleLinkBarcode} onClose={()=>setPendingBarcode(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
